<html>
<head>
  <title>src/audio_example.c</title>
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>
<font color="#444444"><i>/*******************************************************************************
*                                                                              *
*   SDL_ffmpeg is a library for basic multimedia functionality.                *
*   SDL_ffmpeg is based on ffmpeg.                                             *
*                                                                              *
*   Copyright (C) 2007  Arjan Houben                                           *
*                                                                              *
*   SDL_ffmpeg is free software: you can redistribute it and/or modify         *
*   it under the terms of the GNU Lesser General Public License as published   *
*	by the Free Software Foundation, either version 3 of the License, or any   *
*   later version.                                                             *
*                                                                              *
*   This program is distributed in the hope that it will be useful,            *
*   but WITHOUT ANY WARRANTY; without even the implied warranty of             *
*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the               *
*   GNU Lesser General Public License for more details.                        *
*                                                                              *
*   You should have received a copy of the GNU Lesser General Public License   *
*   along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.      *
*                                                                              *
*******************************************************************************/</i></font>

<font color="0000ff"><strong>#include <font color="#008000">&quot;SDL/SDL.h&quot;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&quot;SDL/SDL_ffmpeg.h&quot;</font></strong></font>

<font color="0000ff"><strong>#include <font color="#008000">&lt;string.h&gt;</font></strong></font>

<strong>int</strong> <font color="#2040a0">audioCallback</font><font color="4444FF">(</font><strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">udata</font>, <font color="#2040a0">Uint8</font> <font color="4444FF">*</font><font color="#2040a0">stream</font>, <strong>int</strong> <font color="#2040a0">len</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>

    <font color="#444444">/* unpack our void pointer */</font>
    <font color="#2040a0">SDL_ffmpegFile</font> <font color="4444FF">*</font><font color="#2040a0">file</font> <font color="4444FF">=</font> <font color="4444FF">(</font><font color="#2040a0">SDL_ffmpegFile</font><font color="4444FF">*</font><font color="4444FF">)</font><font color="#2040a0">udata</font><font color="4444FF">;</font>

    <strong>int</strong> <font color="#2040a0">bytesUsed</font><font color="4444FF">;</font>
    <strong>int</strong> <font color="#2040a0">offset</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
    <font color="#2040a0">SDL_ffmpegAudioFrame</font> <font color="4444FF">*</font><font color="#2040a0">frame</font> <font color="4444FF">=</font> <font color="#2040a0">SDL_ffmpegGetAudioFrame</font><font color="4444FF">(</font><font color="#2040a0">file</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>if</strong><font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">frame</font><font color="4444FF">)</font> <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>

    <strong>while</strong><font color="4444FF">(</font><font color="#2040a0">len</font> <font color="4444FF">&gt;</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>

        <font color="#444444">/* check if we need a new frame */</font>
        <strong>if</strong><font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">frame</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
            <font color="#2040a0">frame</font> <font color="4444FF">=</font> <font color="#2040a0">SDL_ffmpegGetAudioFrame</font><font color="4444FF">(</font><font color="#2040a0">file</font><font color="4444FF">)</font><font color="4444FF">;</font>
            <strong>if</strong><font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">frame</font><font color="4444FF">)</font> <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
        <font color="4444FF"><strong>}</strong></font>

        <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">frame</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font> <font color="4444FF">&lt;</font><font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
            <font color="#444444">/* this frame is smaller or equal to the amount of data needed. */</font>
            <font color="#2040a0">bytesUsed</font> <font color="4444FF">=</font> <font color="#2040a0">frame</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">size</font><font color="4444FF">;</font>
        <font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
            <font color="#444444">/* this frame has more data than needed */</font>
            <font color="#2040a0">bytesUsed</font> <font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
        <font color="4444FF"><strong>}</strong></font>

        <font color="#444444">/* copy the correct amount of data */</font>
        <font color="#2040a0">memcpy</font><font color="4444FF">(</font><font color="#2040a0">stream</font><font color="4444FF">+</font><font color="#2040a0">offset</font>, <font color="#2040a0">frame</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">buffer</font>, <font color="#2040a0">bytesUsed</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <font color="#444444">/* adjust the needed length accordingly */</font>
        <font color="#2040a0">len</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="#2040a0">bytesUsed</font><font color="4444FF">;</font>
        <font color="#2040a0">offset</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">bytesUsed</font><font color="4444FF">;</font>

        <font color="#444444">/* we release our audio data, so the decode thread can fill it again */</font>
        <font color="#444444">/* we also inform this function of the amount of bytes we used, so it can */</font>
        <font color="#444444">/* move the buffer accordingly */</font>
        <font color="#444444">/* important! this call is paired with SDL_ffmpegGetAudio */</font>
        <font color="#2040a0">SDL_ffmpegReleaseAudio</font><font color="4444FF">(</font><font color="#2040a0">file</font>, <font color="#2040a0">frame</font>, <font color="#2040a0">bytesUsed</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>int</strong> <font color="#2040a0">main</font><font color="4444FF">(</font><strong>int</strong> <font color="#2040a0">argc</font>, <strong>char</strong><font color="4444FF">*</font><font color="4444FF">*</font> <font color="#2040a0">argv</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>

    <font color="#444444">/* check if we got an argument */</font>
    <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">argc</font> <font color="4444FF">&lt;</font> <font color="#FF0000">2</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;usage: <font color="#77dd77">\&quot;</font>%s<font color="#77dd77">\&quot;</font> <font color="#77dd77">\&quot;</font>filename<font color="#77dd77">\&quot;</font><font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* standard SDL initialization stuff */</font>
    <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">SDL_Init</font><font color="4444FF">(</font><font color="#2040a0">SDL_INIT_AUDIO</font><font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">fprintf</font><font color="4444FF">(</font><font color="#2040a0">stderr</font>, <font color="#008000">&quot;problem initializing SDL: %s<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">SDL_GetError</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* open file from arg[1] */</font>
    <font color="#2040a0">SDL_ffmpegFile</font><font color="4444FF">*</font> <font color="#2040a0">audioFile</font> <font color="4444FF">=</font> <font color="#2040a0">SDL_ffmpegOpen</font><font color="4444FF">(</font><font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#FF0000">1</font><font color="4444FF">]</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <strong>if</strong><font color="4444FF">(</font><font color="4444FF">!</font><font color="#2040a0">audioFile</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;error opening file<font color="#77dd77">\n</font>&quot;</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* print some info on detected stream to output */</font>
    <strong>int</strong> <font color="#2040a0">s</font><font color="4444FF">;</font>
    <font color="#2040a0">SDL_ffmpegStream</font> <font color="4444FF">*</font><font color="#2040a0">str</font><font color="4444FF">;</font>

    <strong>for</strong><font color="4444FF">(</font><font color="#2040a0">s</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font> <font color="#2040a0">s</font><font color="4444FF">&lt;</font><font color="#2040a0">audioFile</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">AStreams</font><font color="4444FF">;</font> <font color="#2040a0">s</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">str</font> <font color="4444FF">=</font> <font color="#2040a0">SDL_ffmpegGetAudioStream</font><font color="4444FF">(</font><font color="#2040a0">audioFile</font>, <font color="#2040a0">s</font><font color="4444FF">)</font><font color="4444FF">;</font>

        <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;Info on audiostream #%i:<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">s</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;<font color="#77dd77">\t</font>Channels: %i<font color="#77dd77">\n</font>&quot;</font>,      <font color="#2040a0">str</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">channels</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">str</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">language</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;<font color="#77dd77">\t</font>Language: %s<font color="#77dd77">\n</font>&quot;</font>,      <font color="#2040a0">str</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">language</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;<font color="#77dd77">\t</font>SampleRate: %i<font color="#77dd77">\n</font>&quot;</font>,    <font color="#2040a0">str</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">sampleRate</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* select the streams you want to decode (example just uses 0 as a default) */</font>
    <font color="#2040a0">SDL_ffmpegSelectAudioStream</font><font color="4444FF">(</font><font color="#2040a0">audioFile</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* get the audiospec which fits the selected videostream, if no videostream */</font>
    <font color="#444444">/* is selected, default values are used (2 channel, 48Khz) */</font>
    <font color="#2040a0">SDL_AudioSpec</font> <font color="4444FF">*</font><font color="#2040a0">specs</font> <font color="4444FF">=</font> <font color="#2040a0">SDL_ffmpegGetAudioSpec</font><font color="4444FF">(</font><font color="#2040a0">audioFile</font>, <font color="#FF0000">512</font>, <font color="#2040a0">audioCallback</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* Open the Audio device */</font>
    <strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">SDL_OpenAudio</font><font color="4444FF">(</font><font color="#2040a0">specs</font>, <font color="#FF0000">0</font><font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
        <font color="#2040a0">printf</font><font color="4444FF">(</font><font color="#008000">&quot;Couldn't open audio: %s<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">SDL_GetError</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">)</font><font color="4444FF">;</font>
        <strong>return</strong> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* we start our decode thread, this always tries to buffer in some frames */</font>
    <font color="#444444">/* so we can enjoy smooth playback */</font>
    <font color="#2040a0">SDL_ffmpegStartDecoding</font><font color="4444FF">(</font><font color="#2040a0">audioFile</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* we unpause the audio so our audiobuffer gets read */</font>
    <font color="#2040a0">SDL_PauseAudio</font><font color="4444FF">(</font><font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* we unpase the file so audio plays */</font>
    <font color="#2040a0">SDL_ffmpegPause</font><font color="4444FF">(</font><font color="#2040a0">audioFile</font>, <font color="#FF0000">0</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <strong>int</strong> <font color="#2040a0">done</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>

    <strong>while</strong><font color="4444FF">(</font> <font color="4444FF">!</font><font color="#2040a0">done</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>

        <font color="#444444">/* just some standard SDL event stuff */</font>
        <font color="#2040a0">SDL_Event</font> <font color="#2040a0">event</font><font color="4444FF">;</font>
        <strong>while</strong><font color="4444FF">(</font><font color="#2040a0">SDL_PollEvent</font><font color="4444FF">(</font><font color="4444FF">&amp;</font><font color="#2040a0">event</font><font color="4444FF">)</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
            <strong>if</strong><font color="4444FF">(</font><font color="#2040a0">event</font>.<font color="#2040a0">type</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">SDL_QUIT</font><font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
                <font color="#2040a0">done</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
                <strong>break</strong><font color="4444FF">;</font>
            <font color="4444FF"><strong>}</strong></font>
        <font color="4444FF"><strong>}</strong></font>

        <font color="#444444">/* we wish not to kill our poor cpu, so we give it some timeoff */</font>
        <font color="#2040a0">SDL_Delay</font><font color="4444FF">(</font><font color="#FF0000">5</font><font color="4444FF">)</font><font color="4444FF">;</font>
    <font color="4444FF"><strong>}</strong></font>

    <font color="#444444">/* after all is said and done, we should call this */</font>
    <font color="#2040a0">SDL_ffmpegFree</font><font color="4444FF">(</font><font color="#2040a0">audioFile</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <font color="#444444">/* the SDL_Quit function offcourse... */</font>
    <font color="#2040a0">SDL_Quit</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>

    <strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

</pre>
<hr>
syntax highlighted by <a href="http://www.palfrader.org/code2html">Code2HTML</a>, v. 0.9.1
</body>
</html>
